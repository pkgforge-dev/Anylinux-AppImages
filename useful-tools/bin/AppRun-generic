#!/bin/sh

# Example AppRun for using the hooks of this repository.
# NOTE: It is meant to be used with sharun which uses a top level bin dir

if [ "$APPRUN_DEBUG" = 1 ]; then
	set -x
fi

set -e

CURRENTDIR="$(cd "${0%/*}" && echo "$PWD")"
APPDIR="$CURRENTDIR"
MAIN_BIN=@MAIN_BIN@
BIN="${ARGV0:-$0}"
BIN="${BIN##*/}"

export APPIMAGE_ARCH=@APPIMAGE_ARCH@
export HOSTPATH="$PATH"
export PATH="$CURRENTDIR/bin:$PATH"
export CURRENTDIR APPDIR

# Allow users to set env variables for specific AppImage
# This feature only works with the uruntime
if [ "$1" = '--appimage-add-env' ]; then
	shift
	for v do
		echo "$v" >> "$APPIMAGE".env
		>&2 echo "Added '$v' to $APPIMAGE.env"
	done
	exit 0
fi

# check host locale works
if command -v locale-check 1>/dev/null && ! locale-check; then
	# use our locales
	__lcdir="$APPDIR"/shared/lib/locale
	[ ! -d "$__lcdir" ] || export LOCPATH="$__lcdir"
	# fallback to bundled C.UTF-8
	locale-check || export LC_ALL=C.UTF-8
	# fallback to bare C locale if this still fails somehow
	locale-check || export LC_ALL=C
fi

# additional scripts can be placed in the top level bin dir
# those with a name that ends up .hook will be executed in the current shell
# those that end with .bg.hook will be executed in the background
# and those that end with .src.hook will be sourced in the AppRun
for hook in "$CURRENTDIR"/bin/*.hook; do
	[ -x "$hook" ] || continue
	case "$hook" in
		*.src.hook) continue ;;
		*.bg.hook)  "$hook" &;;
		*.hook)     "$hook"  ;;
	esac
done

# source hooks need to run last
for hook in "$CURRENTDIR"/bin/*.src.hook; do
	[ -e "$hook" ] || continue
	. "$hook"
done

# always unset ARGVO to avoid causing issues to child processes that use zsh
# We do it after running the hooks since some hooks need it
unset ARGV0

# Check if BIN (ARGV0) matches a binary, fallback to $1, then binary in .desktop
if [ -f "$CURRENTDIR"/bin/"$BIN" ]; then
	TO_LAUNCH="$CURRENTDIR"/bin/"$BIN"
elif [ -f "$CURRENTDIR"/bin/"$1" ]; then
	TO_LAUNCH="$CURRENTDIR"/bin/"$1"
	shift
else
	TO_LAUNCH="$CURRENTDIR"/bin/"$MAIN_BIN"
fi

# If LD_DEBUG=libs is set outside the AppImage the output is not helpful
# because it will include the libs of sh, grep, cat, etc from the hooks
# with this var we can set LD_DEBUG=libs for the bundled application only
if [ "$APPIMAGE_DEBUG" = 1 ]; then
	export LD_DEBUG=libs
	export VK_LOADER_DEBUG=all
	export LC_ALL=C
	export SHARUN_PRINTENV=1
	"$TO_LAUNCH" "$@" 2>"$HOME"/"${APPIMAGE##*/}"-debug.log || :
	>&2 echo "Debug log at: '$HOME/${APPIMAGE##*/}-debug.log'"
else
	exec "$TO_LAUNCH" "$@"
fi
